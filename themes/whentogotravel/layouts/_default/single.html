{{ define "main" }}
<article class="article" itemscope itemtype="https://schema.org/Article">

  {{/* ---- HERO ---- */}}
  <header class="article-hero">
    {{ if .Params.hero_image }}
    <div class="article-hero__image">
      <img src="{{ .Params.hero_image | relURL }}" alt="{{ .Params.hero_alt }}" width="1400" height="700" loading="eager" itemprop="image">
      <div class="article-hero__overlay"></div>
    </div>
    {{ else }}
    <div class="article-hero__image article-hero__image--empty">
      <div class="article-hero__overlay"></div>
    </div>
    {{ end }}
    <div class="article-hero__content">
      {{ if .Params.region }}
      <span class="article-hero__region">{{ .Params.region }}</span>
      {{ end }}
      <h1 class="article-hero__title" itemprop="headline">{{ .Title }}</h1>
      <p class="article-hero__meta">
        By <a href="{{ "/about/elena-vasquez/" | relURL }}" itemprop="author">{{ .Site.Params.author }}</a>
        &middot; Updated <time datetime="{{ .Lastmod.Format "2006-01-02" }}" itemprop="dateModified">{{ .Lastmod.Format "January 2, 2006" }}</time>
        {{ if .Params.best_months }}
        &middot; Best time: <strong>{{ .Params.best_months }}</strong>
        {{ end }}
      </p>
      {{ if .Params.hero_credit }}
      <p class="article-hero__credit">{{ .Params.hero_credit }}</p>
      {{ end }}
    </div>
  </header>

  {{/* ---- ARTICLE BODY ---- */}}
  <div class="article-layout">

    {{/* Sidebar: TOC */}}
    <aside class="article-sidebar">
      {{ if .TableOfContents }}
      <nav class="toc" aria-label="Table of Contents">
        <p class="toc__label">In This Guide</p>
        {{ .TableOfContents }}
      </nav>
      {{ end }}
    </aside>

    {{/* Main content */}}
    <div class="article-body" itemprop="articleBody">

      {{/* Climate chart -- prominent, near top */}}
      {{ if .Params.climate_chart }}
      <figure class="climate-chart">
        <img src="{{ .Params.climate_chart | relURL }}" alt="Monthly climate overview for {{ .Params.country_name }} showing best times to visit" width="1792" height="1024" loading="eager">
        <figcaption>Monthly climate overview for {{ .Params.country_name }} &mdash; AI-generated infographic</figcaption>
      </figure>
      {{ end }}

      {{/* Article content */}}
      <div class="prose">
        {{ .Content }}
      </div>

      {{/* TourRadar CTA */}}
      {{ partial "tourradar-cta.html" . }}

      {{/* FAQ section */}}
      {{ if .Params.faq }}
      <section class="faq-section" aria-label="Frequently Asked Questions">
        <h2 class="faq-section__title">Frequently Asked Questions</h2>
        <div class="faq-list">
          {{ range .Params.faq }}
          <details class="faq-item">
            <summary class="faq-item__question">{{ .question }}</summary>
            <div class="faq-item__answer">
              <p>{{ .answer }}</p>
            </div>
          </details>
          {{ end }}
        </div>
      </section>
      {{ end }}

      {{/* References / Sources -- use frontmatter if available, generic fallback for old articles */}}
      {{ if .Params.country_name }}
      <section class="references" aria-label="Sources and References">
        <h2 class="references__title">Sources &amp; References</h2>
        <ul class="references__list">
          {{ if .Params.references }}
            {{/* New articles: country-specific references from frontmatter */}}
            {{ range .Params.references }}
            <li><a href="{{ .url }}" rel="noopener" target="_blank">{{ .title }}</a> &mdash; {{ .description }}</li>
            {{ end }}
            {{ if $.Params.tourradar_url }}
            <li><a href="{{ $.Params.tourradar_url }}" rel="sponsored noopener" target="_blank">TourRadar: {{ $.Params.country_name }} Tours</a> &mdash; Multi-day guided tours</li>
            {{ end }}
          {{ else }}
            {{/* Fallback for older articles without references in frontmatter */}}
            <li><a href="https://www.lonelyplanet.com/{{ .Params.country_name | urlize }}" rel="noopener" target="_blank">Lonely Planet: {{ .Params.country_name }}</a> &mdash; Destination overview</li>
            <li><a href="https://travel.state.gov/" rel="noopener" target="_blank">U.S. Department of State</a> &mdash; Travel advisories</li>
            {{ if .Params.tourradar_url }}
            <li><a href="{{ .Params.tourradar_url }}" rel="sponsored noopener" target="_blank">TourRadar: {{ .Params.country_name }} Tours</a> &mdash; Multi-day guided tours</li>
            {{ end }}
          {{ end }}
        </ul>
      </section>
      {{ end }}

      {{/* Related countries -- only show published articles (no 404 links) */}}
      {{ if .Params.related_countries }}
      {{ $hasRelated := false }}
      {{ $relatedPages := slice }}
      {{ range .Params.related_countries }}
        {{ $page := $.Site.GetPage (printf "/countries/%s" .) }}
        {{ if $page }}
          {{ $relatedPages = $relatedPages | append $page }}
        {{ end }}
      {{ end }}
      {{ if gt (len $relatedPages) 0 }}
      <section class="related" aria-label="Related Destinations">
        <h2 class="related__title">Continue Exploring</h2>
        <div class="related__grid">
          {{ range $relatedPages }}
          <a href="{{ .RelPermalink }}" class="related__card">
            {{ if .Params.hero_image }}
            <img src="{{ .Params.hero_image | relURL }}" alt="{{ .Params.hero_alt }}" loading="lazy">
            {{ end }}
            <span class="related__card-name">{{ .Params.country_name }}</span>
          </a>
          {{ end }}
        </div>
      </section>
      {{ end }}
      {{ end }}

      {{/* Author bio */}}
      {{ partial "author-bio.html" . }}

    </div>
  </div>

</article>
{{ end }}
